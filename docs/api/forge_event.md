# forge_event

Event system for handling user interactions and widget notifications in ForGE applications.

## Synopsis

```fortran
type :: forge_event
    integer :: type = 0
    type(forge_event_data) :: data
end type forge_event

type :: forge_event_handler
    private
    procedure(event_callback_interface), pointer, nopass :: callback => null()
    integer :: event_type = 0
contains
    procedure :: set_callback => forge_event_handler_set_callback
    procedure :: get_event_type => forge_event_handler_get_event_type
end type forge_event_handler

abstract interface
    subroutine event_callback_interface(event)
        import :: forge_event
        type(forge_event), intent(in) :: event
    end subroutine event_callback_interface
end interface
```

## Description

The ForGE event system provides a unified way to handle user interactions and widget state changes. It supports:

- Event-driven programming model
- Type-safe event handling
- Observer pattern implementation
- Cross-platform event abstraction

Events are generated by widgets and processed through registered callback functions.

## Event Types

ForGE defines standard event types:

- `EVENT_BUTTON_CLICKED`: Button pressed
- `EVENT_WINDOW_CLOSED`: Window close requested
- `EVENT_KEY_PRESSED`: Keyboard key pressed
- `EVENT_MOUSE_MOVED`: Mouse movement
- `EVENT_TEXT_CHANGED`: Text input modified
- `EVENT_VALUE_CHANGED`: Widget value changed

## Core Components

### forge_event
Container for event information:

```fortran
type :: forge_event
    integer :: type = 0
    type(forge_event_data) :: data
end type forge_event
```

### forge_event_handler
Manages event callback registration:

```fortran
type :: forge_event_handler
    procedure(event_callback_interface), pointer :: callback => null()
    integer :: event_type = 0
end type forge_event_handler
```

## Methods

### forge_event_handler Methods

#### set_callback(callback, event_type)
Registers an event callback function.

**Parameters:**
- `callback` (procedure): Event handler subroutine
- `event_type` (integer): Type of event to handle

**Example:**
```fortran
call handler%set_callback(my_callback, EVENT_BUTTON_CLICKED)

subroutine my_callback(event)
    type(forge_event), intent(in) :: event
    print *, "Button clicked!"
end subroutine my_callback
```

#### get_event_type()
Gets the registered event type.

**Returns:** integer - Event type identifier

## Event Handling Pattern

### Widget Event Registration
```fortran
type(forge_button) :: button

call button%on_click(handle_click)

subroutine handle_click(event)
    type(forge_event), intent(in) :: event
    ! Handle button click
    call perform_action()
end subroutine handle_click
```

### Window Event Registration
```fortran
type(forge_window_t) :: window

call window%on_close(handle_close)

subroutine handle_close(event)
    type(forge_event), intent(in) :: event
    ! Handle window close
    call save_data()
    call cleanup_resources()
end subroutine handle_close
```

## Event Types

### Button Events
```fortran
call button%on_click(clicked_handler)

subroutine clicked_handler(event)
    type(forge_event), intent(in) :: event
    select case (event%type)
    case (EVENT_BUTTON_CLICKED)
        ! Button was pressed
    end select
end subroutine clicked_handler
```

### Text Input Events
```fortran
call entry%on_change(text_changed_handler)

subroutine text_changed_handler(event)
    type(forge_event), intent(in) :: event
    select case (event%type)
    case (EVENT_TEXT_CHANGED)
        ! Text was modified
        call validate_input()
    end select
end subroutine text_changed_handler
```

### Value Change Events
```fortran
call slider%on_value_changed(value_changed_handler)

subroutine value_changed_handler(event)
    type(forge_event), intent(in) :: event
    select case (event%type)
    case (EVENT_VALUE_CHANGED)
        ! Slider value changed
        call update_display()
    end select
end subroutine value_changed_handler
```

## Event Data

Events may contain additional data:

```fortran
type :: forge_event_data
    integer :: key_code = 0      ! For keyboard events
    integer :: mouse_x = 0       ! For mouse events
    integer :: mouse_y = 0       ! For mouse events
    character(len=:), allocatable :: text  ! For text events
    real(c_double) :: value = 0.0  ! For value events
end type forge_event_data
```

## Event Propagation

Events follow these rules:

- Events are delivered to registered handlers
- Multiple handlers can be registered for the same event
- Event processing is synchronous
- Handlers should not block for long periods

## Thread Safety

Event handling is not thread-safe:

- Event callbacks execute on the main GUI thread
- Long-running operations in callbacks can freeze the UI
- Use asynchronous operations for background work

## Best Practices

### Keep Callbacks Short
```fortran
! Good: Quick response
subroutine quick_callback(event)
    type(forge_event), intent(in) :: event
    call update_ui_status("Processing...")
    call start_background_task()
end subroutine quick_callback

! Bad: Long-running operation
subroutine slow_callback(event)
    type(forge_event), intent(in) :: event
    call long_computation()  ! Blocks UI!
end subroutine slow_callback
```

### Use Event Types
```fortran
subroutine generic_handler(event)
    type(forge_event), intent(in) :: event

    select case (event%type)
    case (EVENT_BUTTON_CLICKED)
        call handle_button_click()
    case (EVENT_TEXT_CHANGED)
        call handle_text_change()
    case (EVENT_VALUE_CHANGED)
        call handle_value_change()
    case default
        ! Unknown event type
    end select
end subroutine generic_handler
```

### Error Handling
```fortran
subroutine safe_callback(event)
    type(forge_event), intent(in) :: event

    ! Use try-catch or check status
    call risky_operation()
    if (error_occurred) then
        call show_error_dialog()
        return
    end if

    call update_ui()
end subroutine safe_callback
```

## Advanced Patterns

### Event Filtering
```fortran
subroutine filtered_callback(event)
    type(forge_event), intent(in) :: event

    ! Only process certain events
    if (event%type /= EVENT_KEY_PRESSED) return
    if (event%data%key_code /= KEY_ENTER) return

    ! Handle Enter key press
    call submit_form()
end subroutine filtered_callback
```

### Event Chaining
```fortran
subroutine chain_handler(event)
    type(forge_event), intent(in) :: event

    ! First handler
    call validate_input()

    ! Trigger another event
    call trigger_custom_event()
end subroutine chain_handler
```

### State Management
```fortran
logical :: form_valid = .false.

subroutine validation_handler(event)
    type(forge_event), intent(in) :: event

    form_valid = validate_all_fields()
    call update_submit_button_state()
end subroutine validation_handler
```

## Common Event Types

### User Interaction Events
- Button clicks
- Menu selections
- Keyboard input
- Mouse movements and clicks

### State Change Events
- Text field changes
- Slider value changes
- Checkbox toggles
- Combo box selections

### Window Events
- Window close
- Window resize
- Window focus changes

## Performance Considerations

- Event callbacks should be lightweight
- Avoid complex computations in handlers
- Use event filtering to reduce processing
- Consider debouncing for rapid events (typing, mouse movement)

## Example Usage

```fortran
program event_demo
    use forge
    implicit none

    type(forge_application) :: app
    type(forge_window_t) :: window
    type(forge_button) :: button
    type(forge_entry) :: entry
    type(forge_status) :: status

    ! Initialize
    call app%init(BACKEND_CUSTOM, status)
    window = app%create_window("Event Demo", 300, 200)

    ! Set up button event
    call button%set_label("Click Me")
    call button%on_click(button_clicked)

    ! Set up text event
    call entry%set_placeholder("Type here...")
    call entry%on_change(text_changed)

    ! Set up window event
    call window%on_close(window_closed)

    ! Show window
    call window%show()
    call app%run()

contains

    subroutine button_clicked(event)
        type(forge_event), intent(in) :: event
        print *, "Button was clicked!"
    end subroutine button_clicked

    subroutine text_changed(event)
        type(forge_event), intent(in) :: event
        character(len=:), allocatable :: text
        text = entry%get_text()
        print *, "Text changed to: ", text
    end subroutine text_changed

    subroutine window_closed(event)
        type(forge_event), intent(in) :: event
        print *, "Window is closing"
        call app%shutdown()
    end subroutine window_closed

end program event_demo
```

## See Also

- [forge_widget](forge_widget.md) - Widget event registration
- [forge_window_t](forge_window_t.md) - Window event handling
- [forge_button](forge_button.md) - Button click events
- [forge_entry](forge_entry.md) - Text change events