# Resource Compiler (rcc) Tool

The ForGE Resource Compiler (rcc) is a build tool that embeds external resources (images, text files, etc.) directly into Fortran executables, enabling self-contained applications without external file dependencies.

## Overview

The rcc tool processes Qt-style resource definition files (.qrc) and generates Fortran modules containing embedded binary data. This provides:

- Self-contained executables with no external file dependencies
- Fast resource access (no file I/O at runtime)
- Cross-platform resource management
- Qt Designer resource compatibility

## Usage

### Basic Usage

```bash
forge_rcc [options] <input_file.qrc>
```

### Command Line Options

- `-o, --output <file>`: Specify output file (default: `qrc_<input>.f90`)
- `-name <name>`: Resource collection name (default: input filename without .qrc)
- `-no-compress`: Disable compression (compression enabled by default)
- `-v, --verbose`: Enable verbose output
- `-h, --help`: Display help information

### Examples

```bash
# Basic resource compilation
forge_rcc resources.qrc

# Custom output and name
forge_rcc -o my_resources.f90 -name myapp resources.qrc

# Disable compression
forge_rcc -no-compress resources.qrc

# Verbose output
forge_rcc -v resources.qrc
```

## Input File Format

The rcc tool processes Qt-style .qrc (Qt Resource Collection) files containing XML resource definitions.

### Basic QRC File Structure

```xml
<!DOCTYPE RCC>
<RCC version="1.0">
<qresource>
    <file>images/logo.png</file>
    <file>texts/help.txt</file>
    <file alias="icon">images/app.ico</file>
    <file>styles/default.qss</file>
</qresource>
</RCC>
```

### Resource File Elements

- **`<file>`**: Specifies a resource file to embed
- **`alias` attribute**: Optional alias for the resource (defaults to file path)
- **File paths**: Relative to the .qrc file location

### Advanced QRC Features

```xml
<!DOCTYPE RCC>
<RCC version="1.0">
<!-- Multiple resource collections -->
<qresource prefix="/icons">
    <file alias="new">create.png</file>
    <file alias="open">open.png</file>
</qresource>

<qresource prefix="/styles">
    <file>main.css</file>
    <file>dark.css</file>
</qresource>

<!-- Language-specific resources -->
<qresource lang="en">
    <file>strings_en.txt</file>
</qresource>

<qresource lang="es">
    <file>strings_es.txt</file>
</qresource>
</RCC>
```

## Generated Output

The rcc tool generates a Fortran module containing embedded resource data:

```fortran
! Generated by ForGE Resource Compiler
module qrc_resources
    use iso_c_binding
    implicit none

    ! Resource data structure
    type :: qresource_data
        character(len=:), allocatable :: name
        integer :: size = 0
        integer :: compressed_size = 0
        integer(kind=c_int8_t), dimension(:), allocatable :: data
        logical :: compressed = .false.
    end type qresource_data

    ! Embedded resource data
    type(qresource_data) :: qresource_1_data = &
        qresource_data(name='images/logo.png', &
                     size=1234, &
                     compressed_size=1234, &
                     compressed=.false., &
                     data=[ &
        int(z'89'), int(z'50'), int(z'4E'), ...  ! Binary data as hex
                     ])

    ! Resource registry
    type(qresource_data), dimension(3), target :: qresources = [ &
        qresource_1_data, &
        qresource_2_data, &
        qresource_3_data &
    ]

contains

    ! Access functions
    function qresource_get(name) result(data)
        character(len=*), intent(in) :: name
        type(qresource_data), pointer :: data
        ! Search for resource by name
    end function qresource_get

    subroutine qresource_list()
        ! List all available resources
    end subroutine qresource_list

end module qrc_resources
```

## Using Embedded Resources

### Basic Resource Access

```fortran
program my_app
    use qrc_resources  ! Generated module

    type(qresource_data), pointer :: logo_data

    ! Get resource by name
    logo_data => qresource_get('images/logo.png')

    if (associated(logo_data)) then
        ! Use the embedded data
        call display_image(logo_data%data, logo_data%size)
    end if

end program my_app
```

### Loading Images

```fortran
subroutine load_embedded_image(name)
    character(len=*), intent(in) :: name
    type(qresource_data), pointer :: image_data
    integer :: width, height

    image_data => qresource_get(name)
    if (associated(image_data)) then
        ! Decode image from embedded data
        call decode_png(image_data%data, image_data%size, width, height)
        call create_texture(width, height, image_data%data)
    end if
end subroutine load_embedded_image
```

### Loading Text Files

```fortran
function load_embedded_text(name) result(text)
    character(len=*), intent(in) :: name
    character(len=:), allocatable :: text
    type(qresource_data), pointer :: text_data

    text_data => qresource_get(name)
    if (associated(text_data)) then
        ! Convert binary data to string
        allocate(character(len=text_data%size) :: text)
        text = transfer(text_data%data, text)
    else
        text = ""
    end if
end function load_embedded_text
```

## Integration with Build Systems

### CMake Integration

```cmake
# Find ForGE
find_package(ForGE REQUIRED)

# Generate resource files
forge_rcc_generate(RCC_SOURCES resources.qrc)

# Add to executable
add_executable(my_app main.f90 ${RCC_SOURCES})
target_link_libraries(my_app ForGE::forge)
```

### FPM Integration

```toml
# fpm.toml
[build]
# Pre-build commands
prebuild = [
    "forge_rcc resources.qrc -o qrc_resources.f90"
]

[[executable]]
name = "my_app"
sources = ["main.f90", "qrc_resources.f90"]
```

### Make Integration

```makefile
# Makefile
RCC = forge_rcc
FORTRAN = gfortran

# Generate resource files
qrc_resources.f90: resources.qrc
	$(RCC) $< -o $@

# Build application
my_app: main.f90 qrc_resources.f90
	$(FORTRAN) $^ -o $@ -lforge
```

## Resource Types

### Images

Common image formats that can be embedded:

- PNG (Portable Network Graphics)
- JPEG/JPG (Joint Photographic Experts Group)
- BMP (Bitmap)
- ICO (Icon)
- SVG (Scalable Vector Graphics)

```xml
<qresource>
    <file>images/logo.png</file>
    <file>images/background.jpg</file>
    <file alias="app_icon">images/icon.ico</file>
</qresource>
```

### Text Files

Configuration files, help text, templates:

```xml
<qresource>
    <file>config/default.ini</file>
    <file>help/user_guide.txt</file>
    <file>templates/report.html</file>
</qresource>
```

### Binary Data

Custom binary formats, fonts, etc.:

```xml
<qresource>
    <file>fonts/custom.ttf</file>
    <file>data/level1.dat</file>
    <file>shaders/fragment.glsl</file>
</qresource>
```

## Compression

### Automatic Compression

By default, rcc compresses resource data to reduce executable size:

```bash
# Enable compression (default)
forge_rcc resources.qrc

# Disable compression
forge_rcc -no-compress resources.qrc
```

### Compression Benefits

- **Reduced executable size**: Smaller binaries
- **Memory efficiency**: Decompressed on demand
- **Fast access**: Minimal decompression overhead

## Performance Considerations

### Resource Access Speed

- **Embedded resources**: Instant access (no file I/O)
- **Memory usage**: Resources loaded into memory
- **Startup time**: Minimal impact (resources in binary)

### Memory Management

```fortran
! Efficient resource usage
program memory_efficient_app
    use qrc_resources

    ! Only load resources when needed
    if (need_logo) then
        call load_embedded_image('images/logo.png')
    end if

    ! Release resources when done
    call unload_unused_resources()

end program memory_efficient_app
```

### Large Resources

For very large resources, consider:

```xml
<!-- Split large resources -->
<qresource>
    <file>textures/high_res.png</file>
    <file>textures/low_res.png</file>
</qresource>
```

```fortran
! Conditional loading based on device capabilities
if (high_performance_device()) then
    call load_resource('textures/high_res.png')
else
    call load_resource('textures/low_res.png')
end if
```

## Error Handling

### Common Errors

1. **Missing resource files**
   ```
   Warning: Cannot open resource file images/logo.png
   Solution: Ensure file exists and path is correct
   ```

2. **Invalid QRC syntax**
   ```
   Error: Unable to parse QRC file
   Solution: Validate XML syntax
   ```

3. **Output file creation failure**
   ```
   Error: Cannot create output file
   Solution: Check write permissions
   ```

### Verbose Mode

Use `-v` for detailed processing information:

```bash
forge_rcc -v resources.qrc
```

Shows:
- Files being processed
- Resources found and sizes
- Compression ratios
- Generated code statistics

## Best Practices

### Resource Organization

1. **Logical grouping**: Group related resources together
2. **Naming conventions**: Use consistent naming schemes
3. **Size optimization**: Compress large resources
4. **Version control**: Track resource files appropriately

### Build System Integration

1. **Dependency tracking**: Rebuild when resources change
2. **Clean builds**: Remove generated files on clean
3. **Cross-platform paths**: Use forward slashes in QRC files
4. **Incremental builds**: Only rebuild changed resources

### Runtime Usage

1. **Lazy loading**: Load resources on demand
2. **Caching**: Cache decoded resources
3. **Error handling**: Handle missing resources gracefully
4. **Memory management**: Free resources when not needed

## Examples

### Game Resources

```xml
<!-- game_resources.qrc -->
<!DOCTYPE RCC>
<RCC version="1.0">
<qresource>
    <file alias="player">sprites/player.png</file>
    <file alias="enemy">sprites/enemy.png</file>
    <file alias="background">levels/bg.png</file>
    <file alias="music">audio/bgm.mp3</file>
    <file alias="config">data/game.ini</file>
</qresource>
</RCC>
```

```fortran
program game
    use qrc_game_resources

    ! Load game assets
    call load_sprite(qresource_get('player'))
    call load_background(qresource_get('background'))
    call play_music(qresource_get('music'))

end program game
```

### Application Icons

```xml
<!-- app_icons.qrc -->
<!DOCTYPE RCC>
<RCC version="1.0">
<qresource>
    <file alias="main_icon">icons/app.png</file>
    <file alias="file_open">icons/open.png</file>
    <file alias="file_save">icons/save.png</file>
    <file alias="edit_copy">icons/copy.png</file>
    <file alias="edit_paste">icons/paste.png</file>
</qresource>
</RCC>
```

```fortran
program icon_demo
    use qrc_app_icons

    ! Set application icon
    call set_window_icon(qresource_get('main_icon'))

    ! Create toolbar with icons
    call add_toolbar_button("Open", qresource_get('file_open'))
    call add_toolbar_button("Save", qresource_get('file_save'))

end program icon_demo
```

### Localization Files

```xml
<!-- translations.qrc -->
<!DOCTYPE RCC>
<RCC version="1.0">
<qresource>
    <file alias="strings_en">i18n/strings_en.txt</file>
    <file alias="strings_es">i18n/strings_es.txt</file>
    <file alias="strings_fr">i18n/strings_fr.txt</file>
</qresource>
</RCC>
```

```fortran
program localized_app
    use qrc_translations

    ! Load appropriate language
    select case (get_user_language())
    case ('es')
        strings = load_embedded_text('strings_es')
    case ('fr')
        strings = load_embedded_text('strings_fr')
    case default
        strings = load_embedded_text('strings_en')
    end select

end program localized_app
```

## Troubleshooting

### Build Issues

**Problem**: Resources not found at runtime
**Solution**: Ensure resource names match exactly (case-sensitive)

**Problem**: Large executable size
**Solution**: Use compression or external resource files

**Problem**: Build system not regenerating resources
**Solution**: Add proper dependencies in build system

### Runtime Issues

**Problem**: Resource loading fails
**Solution**: Check resource name spelling and availability

**Problem**: Memory issues with large resources
**Solution**: Implement resource streaming or compression

**Problem**: Performance issues
**Solution**: Profile resource access patterns and optimize

## See Also

- [MOC Tool](moc_tool.md) - Meta-object compiler
- [UIC Tool](uic_tool.md) - UI compiler
- [Qt Resource System](https://doc.qt.io/qt-5/resources.html)
- [Resource Management Tutorial](../tutorials/resource_management.md)